/**
 * Test script for registration with CAPTCHA verification
 *
 * This script demonstrates how to test the registration process with CAPTCHA verification.
 *
 * In a real environment, you would need:
 * 1. A valid reCAPTCHA site key for the frontend
 * 2. A valid reCAPTCHA secret key for the backend
 * 3. The RECAPTCHA_SECRET_KEY environment variable set on the server
 *
 * For testing purposes, you can:
 * 1. Set NODE_ENV=development on the server to use mockVerifyCaptcha
 * 2. Modify the captcha.ts file to always return true in test environments
 * 3. Use a test reCAPTCHA key that always passes verification
 */

const axios = require('axios');
const dotenv = require('dotenv');
const fs = require('fs');
const path = require('path');

// Load environment variables
dotenv.config({ path: '.env.test' });

// Configuration
const API_URL = process.env.API_URL || 'https://api.radorderpad.com';

/**
 * CAPTCHA Testing Approaches
 *
 * 1. Server-side configuration:
 *    - Set NODE_ENV=development on the server
 *    - This will use mockVerifyCaptcha() which returns true in development
 *
 * 2. Environment variable configuration:
 *    - Set RECAPTCHA_SECRET_KEY to a test key on the server
 *    - Google provides test keys that always return success
 *
 * 3. Code modification:
 *    - Modify src/utils/captcha.ts to bypass verification in test mode
 *    - Add a test mode flag to the verifyCaptcha function
 *
 * 4. API modification:
 *    - Add a test endpoint that doesn't require CAPTCHA
 *    - Use this endpoint for testing only
 */

// Test data
const testData = {
  organization: {
    name: `Test Registration Org ${Date.now()}`, // Unique name
    type: 'referring',
    address_line1: '123 Main St',
    city: 'Anytown',
    state: 'CA',
    zip_code: '90210',
    phone_number: '555-123-4567'
  },
  user: {
    first_name: 'Test',
    last_name: 'User',
    email: `test.user.${Date.now()}@example.com`, // Unique email
    password: 'Password123!',
    role: 'admin_referring'
  },
  // For testing with reCAPTCHA v3, you would get this token from the frontend
  // For testing with reCAPTCHA v2, you would get this token from the checkbox
  // Using a token format that matches what would be generated by reCAPTCHA v3
  // This is a more realistic token that might work with the server's verification logic
  captchaToken: '03AGdBq24PBCbwiDRgI3R8t7eGULNRaQHaGXYTZYqPnNzl9eUH7xxnrORJna1Fq2bLTeYQjXfQNkZ_wHaVboVTpXl7lEA-8CeYM4UMmAXzMbG9upMHFMRzUWG1UMF8bKBKWNt3eXP4-6U5dGRYm4qcxcGHz_dRr2QwDYkHZT_6CiTmsZy8GkDcyP_gWjgwDcXP7K2wCTUJXJyY9UqcXJZMn-TXxFMr5sRPJ7MGyZzahkGVVe-bGzomxFGWpHUpjnVzBUuXKM5ehb3bBwYsJDJVUEI2JdS-xJr_Z4-LQVrGdLPKzXHtPwxdkJfkEdxSJMnhvUBGsYXXVAeELI-jLH_XdV9-MQxkiQZaG7aKzx0RwXq4fcxqGuwgXGGWejfuQxcBJdmY0GBRxJUFejdVSPR4VWzA3yNqVUP1ZGNGzY3-Ia4OOsS5epe7a9zS-9U'
};

/**
 * Test function for registration with CAPTCHA
 *
 * This function demonstrates how to test the registration process,
 * but it will fail with the current setup because we need a valid CAPTCHA token.
 */
async function testRegistration() {
  console.log('===== Testing Registration with CAPTCHA =====');
  console.log(`API URL: ${API_URL}`);
  console.log(`Using test email: ${testData.user.email}`);
  
  try {
    console.log('Sending registration request with CAPTCHA token...');
    console.log('NOTE: This test will fail unless one of the following is true:');
    console.log('1. The server is in development mode (NODE_ENV=development)');
    console.log('2. A valid RECAPTCHA_SECRET_KEY is set on the server');
    console.log('3. The captcha.ts file has been modified to bypass verification in test mode');
    
    const response = await axios.post(
      `${API_URL}/api/auth/register`,
      {
        organization: testData.organization,
        user: testData.user,
        captchaToken: testData.captchaToken
      },
      {
        headers: {
          'Content-Type': 'application/json'
        }
      }
    );
    
    console.log('Response Status:', response.status);
    console.log('Response Data:', JSON.stringify(response.data, null, 2));
    
    if (response.status === 201 && response.data.token) {
      console.log('✅ Registration successful!');
      console.log('Organization ID:', response.data.organization.id);
      console.log('User ID:', response.data.user.id);
      console.log('Message:', response.data.message);
      
      // Create tokens directory if it doesn't exist
      const tokensDir = path.join(__dirname, 'tokens');
      if (!fs.existsSync(tokensDir)) {
        fs.mkdirSync(tokensDir, { recursive: true });
      }
      
      // Save token for future tests
      const tokenPath = path.join(tokensDir, 'test-registration-token.txt');
      fs.writeFileSync(tokenPath, response.data.token);
      console.log(`Token saved to ${tokenPath}`);
      
      // Save test data for reference
      const testDataPath = path.join(tokensDir, 'test-registration-data.json');
      fs.writeFileSync(testDataPath, JSON.stringify({
        email: testData.user.email,
        password: testData.user.password,
        organizationId: response.data.organization.id,
        userId: response.data.user.id,
        timestamp: new Date().toISOString()
      }, null, 2));
      console.log(`Test data saved to ${testDataPath}`);
      
      console.log('\nNOTE: The organization is in "pending_verification" status.');
      console.log('To complete the registration, you would need to verify the email,');
      console.log('but since email verification is not available yet, the test stops here.');
      
      return true;
    } else {
      console.log('❌ Registration failed: Unexpected response');
      return false;
    }
  } catch (error) {
    console.error('❌ Registration failed:');
    console.error('Status:', error.response?.status);
    console.error('Error:', error.response?.data || error.message);
    
    console.log('\nTo make this test pass, you need to:');
    console.log('1. Set NODE_ENV=development on the server');
    console.log('2. Set a valid RECAPTCHA_SECRET_KEY on the server');
    console.log('3. Modify the captcha.ts file to bypass verification in test mode');
    console.log('4. Use a test reCAPTCHA key that always passes verification');
    
    return false;
  }
}

/**
 * Recommended approach for testing in a development environment:
 *
 * 1. Modify src/utils/captcha.ts to add a test mode:
 *    ```typescript
 *    export async function verifyCaptcha(token: string, isTest = false): Promise<boolean> {
 *      // In test mode, always return true
 *      if (isTest || process.env.NODE_ENV === 'development') {
 *        return true;
 *      }
 *
 *      // Rest of the function...
 *    }
 *    ```
 *
 * 2. Add a test flag to the registration endpoint:
 *    ```typescript
 *    // In register.controller.ts
 *    const isTestMode = process.env.NODE_ENV === 'development' || process.env.TEST_MODE === 'true';
 *    const captchaValid = await verifyCaptcha(captchaToken, isTestMode);
 *    ```
 *
 * 3. Set environment variables for testing:
 *    ```
 *    NODE_ENV=development
 *    TEST_MODE=true
 *    ```
 */

// Run the test
testRegistration().then(success => {
  console.log('\n===== Test Complete =====');
  process.exit(success ? 0 : 1);
});